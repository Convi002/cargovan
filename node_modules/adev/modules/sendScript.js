const toAeClient = require('./tcpClient');
const fs = require('fs');
const path = require('path');

module.exports = function(settings, msg) {
	let host = '127.0.0.1';
	let port = settings.port;
	if (msg.indexOf('.jsx') != -1) {
		toAeClient(host, port, msg);
	} else if (msg.indexOf('.html') != -1) {
		const parserXml = require('xml2json');
		const cheerio = require('cheerio');
		const html = fs.readFileSync(msg, 'utf8');
		const $ = cheerio.load(html);
		const scriptTag = $('#livereload');
		if (!scriptTag[0]) {
			let lrContent = `<script id="livereload" type="text/javascript">
				(function() {
					var csInterface = new CSInterface();
					csInterface.addEventListener('ext.reload', function(event) {
						if (event.data == true) {
							csInterface.closeExtension();
							csInterface.removeEventListener('ext.reload');
						} else {
							window.location.reload(true);
						}
					});
				})();
			</script>\r\n`;
			$('body').append(lrContent);
			fs.writeFileSync(msg, $.html());
		}

		let manifestStr = fs.readFileSync(path.resolve(path.dirname(msg), 'csxs/manifest.xml'), 'utf8');
		const manifest = JSON.parse(parserXml.toJson(manifestStr, { reversible: true }));
		let extId = manifest.ExtensionManifest.ExtensionList.Extension.Id;
		toAeClient(host, port, extId);
	}
};
